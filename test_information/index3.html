<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>テスト情報一覧（ハイブリッドカード）</title>
    <link rel="stylesheet" href="../styles.css" />
    <style>
      body.information-dashboard {
        margin: 0;
        min-height: 100vh;
        display: block;
        background: var(--gradient-base);
        color: var(--text-strong);
        font-family: "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif;
        padding: clamp(1.6rem, 3vw, 3rem);
        overflow-y: auto;
      }

      .information-shell {
        display: flex;
        flex-direction: column;
        gap: clamp(1.6rem, 2.4vw, 2.8rem);
      }

      .information-hero {
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius-lg);
        border: 0.0625rem solid var(--border);
        padding: clamp(1.6rem, 2vw + 1.4rem, 2.4rem);
        display: flex;
        flex-direction: column;
        gap: clamp(1rem, 1.6vw, 1.8rem);
        box-shadow: var(--shadow-md);
      }

      .information-hero__head {
        display: flex;
        flex-wrap: wrap;
        gap: clamp(1rem, 1.6vw, 1.8rem);
        justify-content: space-between;
        align-items: flex-start;
      }

      .information-hero__title {
        margin: 0;
        font-size: clamp(2rem, 1vw + 1.8rem, 2.5rem);
        letter-spacing: 0.05em;
      }

      .information-hero__lead {
        margin: 0;
        color: var(--text-muted);
        max-width: 54ch;
        line-height: 1.6;
        font-size: clamp(0.95rem, 0.3vw + 0.85rem, 1.05rem);
      }

      .information-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(14rem, 1fr));
        gap: clamp(1rem, 1.4vw, 1.6rem);
      }

      .summary-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius-lg);
        border: 0.0625rem solid var(--border);
        padding: clamp(1.1rem, 1.3vw + 0.9rem, 1.6rem);
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        box-shadow: var(--shadow-md);
      }

      .summary-card__label {
        margin: 0;
        font-size: clamp(0.8rem, 0.25vw + 0.75rem, 0.92rem);
        color: var(--text-muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 600;
      }

      .summary-card__value {
        margin: 0;
        font-size: clamp(1.4rem, 0.6vw + 1.2rem, 1.8rem);
        font-weight: 700;
        color: var(--accent-primary);
      }

      .information-content {
        display: grid;
        grid-template-columns: minmax(18rem, 24rem) minmax(0, 1fr);
        gap: clamp(1.6rem, 2.6vw, 3rem);
        align-items: start;
      }

      @media (max-width: 1024px) {
        .information-content {
          grid-template-columns: 1fr;
        }
      }

      .filter-card {
        background: var(--panel);
        border-radius: var(--radius-lg);
        border: 0.0625rem solid var(--border);
        box-shadow: var(--shadow-md);
        padding: clamp(1.2rem, 1.4vw + 1rem, 1.8rem);
        display: flex;
        flex-direction: column;
        gap: clamp(1rem, 1.2vw, 1.4rem);
      }

      .filter-card__heading {
        margin: 0;
        font-size: clamp(1.2rem, 0.5vw + 1rem, 1.45rem);
      }

      .filter-card__description {
        margin: 0;
        font-size: clamp(0.85rem, 0.25vw + 0.8rem, 0.95rem);
        color: var(--text-muted);
      }

      .dashboard-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(9rem, 1fr));
        gap: clamp(0.8rem, 1vw, 1.2rem);
      }

      .filter-actions {
        display: flex;
        gap: clamp(0.5rem, 0.8vw, 1rem);
        flex-wrap: wrap;
      }

      .filter-button {
        flex: 1 1 8rem;
      }

      .clear-button {
        flex: 1 1 8rem;
        padding: clamp(0.6rem, 0.8vw + 0.4rem, 0.9rem)
          clamp(1rem, 1.2vw + 0.7rem, 1.4rem);
        border-radius: var(--radius-sm);
        border: 0.0625rem solid var(--border);
        background: rgba(255, 255, 255, 0.7);
        color: var(--text-strong);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }

      .clear-button:hover {
        background: rgba(63, 114, 255, 0.1);
      }

      .data-table-container {
        background: var(--panel);
        border-radius: var(--radius-lg);
        border: 0.0625rem solid var(--border);
        box-shadow: var(--shadow-md);
        padding: clamp(1.2rem, 1.4vw + 1rem, 1.8rem);
        display: flex;
        flex-direction: column;
        gap: clamp(0.9rem, 1.2vw, 1.4rem);
      }

      .data-table-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: clamp(0.8rem, 1vw, 1.2rem);
        align-items: center;
      }

      .data-table-wrapper {
        max-height: 60vh;
        overflow: auto;
        border-radius: var(--radius-md);
        border: 0.0625rem solid rgba(32, 45, 74, 0.08);
      }

      .sidebar-footnote {
        margin: 0;
        font-size: clamp(0.85rem, 0.25vw + 0.8rem, 0.95rem);
        color: var(--text-muted);
      }

      .data-table-empty {
        text-align: center;
        padding: clamp(1.5rem, 1.8vw + 1rem, 2rem);
        color: var(--text-muted);
      }
    </style>
  </head>
  <body class="information-dashboard">
    <div class="shell information-shell">
      <header class="information-hero">
        <div class="information-hero__head">
          <div>
            <h1 class="information-hero__title">粉体物性情報ダッシュボード</h1>
            <p class="information-hero__lead">
              期間を指定して粉体物性の記録を確認できます。カードで主要指標を素早く確認し、詳細は表で掘り下げてください。
            </p>
          </div>
        </div>
        <div class="information-summary-grid">
          <div class="summary-card">
            <p class="summary-card__label">Current Range</p>
            <p class="summary-card__value" id="header-range">全期間</p>
            <p class="sidebar-footnote" id="selected-range">表示期間: 全期間</p>
          </div>
          <div class="summary-card">
            <p class="summary-card__label">Visible Records</p>
            <p class="summary-card__value" id="summary-record-count">0件</p>
            <p class="sidebar-footnote">表に表示されている件数です。</p>
          </div>
        </div>
      </header>
      <main class="information-content">
        <aside class="filter-card">
          <h2 class="filter-card__heading">期間フィルター</h2>
          <p class="filter-card__description">
            表示したい期間を指定し、表示更新またはクリアで調整してください。
          </p>
          <form class="dashboard-filters" id="filter-form" aria-label="期間フィルター">
            <div class="filter-group">
              <label class="filter-label" for="date-from">開始日</label>
              <input class="filter-input" type="date" id="date-from" name="date-from" />
            </div>
            <div class="filter-group">
              <label class="filter-label" for="date-to">終了日</label>
              <input class="filter-input" type="date" id="date-to" name="date-to" />
            </div>
          </form>
          <div class="filter-actions">
            <button type="button" class="filter-button" id="filter-button">表示更新</button>
            <button type="button" class="clear-button" id="clear-button">条件クリア</button>
          </div>
        </aside>
        <section class="data-table-container" aria-live="polite">
          <div class="data-table-header">
            <h2>粉体物性情報一覧</h2>
            <p class="data-table-meta" id="record-count">表示件数: 0件</p>
          </div>
          <div class="data-table-wrapper">
            <table class="data-table" id="information-table">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
    <script>
      const csvPath = "./data/test_information.csv";
      let cachedRows = null;

      async function ensureCsvRows() {
        if (cachedRows) {
          return cachedRows;
        }
        const response = await fetch(csvPath);
        if (!response.ok) {
          throw new Error("CSVの取得に失敗しました");
        }
        const text = await response.text();
        cachedRows = parseCsv(text);
        return cachedRows;
      }

      function parseCsv(text) {
        return text
          .trim()
          .split(/\r?\n/)
          .filter((line) => line.trim() !== "")
          .map((line) => line.split(","));
      }

      function parseDateInput(value) {
        if (!value) {
          return null;
        }
        const [year, month, day] = value.split("-").map(Number);
        if (!year || !month || !day) {
          return null;
        }
        return new Date(year, month - 1, day);
      }

      function parseRecordDate(value) {
        if (!value) {
          return null;
        }
        const [year, month, day] = value.split("-").map(Number);
        if (!year || !month || !day) {
          return null;
        }
        return new Date(year, month - 1, day);
      }

      function formatDateForDisplay(value) {
        if (!value) {
          return "";
        }
        const year = value.getFullYear();
        const month = String(value.getMonth() + 1).padStart(2, "0");
        const day = String(value.getDate()).padStart(2, "0");
        return `${year}/${month}/${day}`;
      }

      function formatRangeLabel(fromDate, toDate) {
        if (!fromDate && !toDate) {
          return "表示期間: 全期間";
        }
        if (fromDate && toDate) {
          return `表示期間: ${formatDateForDisplay(fromDate)} 〜 ${formatDateForDisplay(toDate)}`;
        }
        if (fromDate) {
          return `表示期間: ${formatDateForDisplay(fromDate)} 以降`;
        }
        return `表示期間: ${formatDateForDisplay(toDate)} 以前`;
      }

      function updateSummaryCounts(filteredLength) {
        const summaryCount = document.getElementById("summary-record-count");
        if (summaryCount) {
          summaryCount.textContent = `${filteredLength}件`;
        }
      }

      function clearFilters() {
        const fromInput = document.getElementById("date-from");
        const toInput = document.getElementById("date-to");
        if (fromInput) {
          fromInput.value = "";
        }
        if (toInput) {
          toInput.value = "";
        }
        applyFilter();
      }

      function renderTable(rows, fromDate, toDate) {
        const table = document.getElementById("information-table");
        const tableHead = table.querySelector("thead");
        const tableBody = table.querySelector("tbody");
        tableHead.innerHTML = "";
        tableBody.innerHTML = "";

        const recordCount = document.getElementById("record-count");
        const rangeLabel = document.getElementById("selected-range");
        const headerRange = document.getElementById("header-range");
        const rangeText = formatRangeLabel(fromDate, toDate);
        if (rows.length === 0) {
          recordCount.textContent = "表示件数: 0件";
          updateSummaryCounts(0);
          if (rangeLabel) {
            rangeLabel.textContent = rangeText;
          }
          if (headerRange) {
            headerRange.textContent = "全期間";
          }
          return;
        }

        const [header, ...records] = rows;
        const headerRow = document.createElement("tr");
        header.forEach((label) => {
          const th = document.createElement("th");
          th.textContent = label.trim();
          headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        const filtered = records.filter((row) => {
          const dateCell = row[0] ? row[0].trim() : "";
          if (!dateCell) {
            return false;
          }
          const recordDate = parseRecordDate(dateCell);
          if (!recordDate) {
            return true;
          }
          if (fromDate && recordDate < fromDate) {
            return false;
          }
          if (toDate && recordDate > toDate) {
            return false;
          }
          return true;
        });

        const filteredLength = filtered.length;
        recordCount.textContent = `表示件数: ${filteredLength}件`;
        updateSummaryCounts(filteredLength);
        if (rangeLabel) {
          rangeLabel.textContent = rangeText;
        }
        if (headerRange) {
          headerRange.textContent = rangeText.replace("表示期間: ", "");
        }

        if (filteredLength === 0) {
          const emptyRow = document.createElement("tr");
          const emptyCell = document.createElement("td");
          emptyCell.colSpan = header.length;
          emptyCell.className = "data-table-empty";
          emptyCell.textContent = "指定された期間のデータはありません";
          emptyRow.appendChild(emptyCell);
          tableBody.appendChild(emptyRow);
          return;
        }

        const fragment = document.createDocumentFragment();
        filtered.forEach((row) => {
          const bodyRow = document.createElement("tr");
          row.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell.trim();
            bodyRow.appendChild(td);
          });
          fragment.appendChild(bodyRow);
        });
        tableBody.appendChild(fragment);
      }

      async function applyFilter() {
        try {
          const rows = await ensureCsvRows();
          const fromInput = document.getElementById("date-from");
          const toInput = document.getElementById("date-to");
          const fromDate = parseDateInput(fromInput.value);
          const toDate = parseDateInput(toInput.value);
          renderTable(rows, fromDate, toDate);
        } catch (error) {
          console.error(error);
          alert(`データの読み込みに失敗しました: ${error.message}`);
        }
      }

      function setupEventHandlers() {
        const button = document.getElementById("filter-button");
        const clearButton = document.getElementById("clear-button");
        const fromInput = document.getElementById("date-from");
        const toInput = document.getElementById("date-to");
        if (button) {
          button.addEventListener("click", applyFilter);
        }
        if (clearButton) {
          clearButton.addEventListener("click", clearFilters);
        }
        [fromInput, toInput].forEach((input) => {
          if (!input) {
            return;
          }
          input.addEventListener("change", applyFilter);
        });
      }

      document.addEventListener("DOMContentLoaded", async () => {
        setupEventHandlers();
        await applyFilter();
      });
    </script>
  </body>
</html>
