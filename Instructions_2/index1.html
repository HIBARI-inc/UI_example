<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ドキュメントカタログビュー・ブランチレイアウト</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <main class="shell">
      <header class="masthead">
        <h1>ドキュメントカタログビュー</h1>
      </header>

      <section class="layout layout--branch" aria-labelledby="layout-branch-heading">
        <h2 id="layout-branch-heading" class="sr-only">
          枝線でカテゴリと製品をつなぐカタログレイアウト
        </h2>

        <div class="branch-canvas" aria-hidden="true">
          <svg class="branch-lines" focusable="false"></svg>
        </div>

        <nav class="category-board branch-rail" aria-label="カテゴリ一覧">
          <p class="category-board__title branch-rail__title">カテゴリを選択</p>
          <ul class="category-folders">
            <li class="category-folder">
              <details class="category-folder__panel" open>
                <summary class="category-folder__summary">供給・搬送オペレーション</summary>
                <ul class="category-folder__list">
                  <li><button class="category" type="button" data-folder="supply">供給システム</button></li>
                  <li><button class="category" type="button" data-folder="transport">搬送・輸送</button></li>
                  <li><button class="category" type="button" data-folder="extraction">取出し・ハンドリング</button></li>
                </ul>
              </details>
            </li>
            <li class="category-folder">
              <details class="category-folder__panel">
                <summary class="category-folder__summary">監視・処理・保全</summary>
                <ul class="category-folder__list">
                  <li><button class="category" type="button" data-folder="measurement">計測・監視</button></li>
                  <li><button class="category" type="button" data-folder="disposal">排出・処理</button></li>
                  <li><button class="category" type="button" data-folder="maintenance">テスト／メンテナンス</button></li>
                </ul>
              </details>
            </li>
            <li class="category-folder">
              <details class="category-folder__panel">
                <summary class="category-folder__summary">保管・設備・導入事例</summary>
                <ul class="category-folder__list">
                  <li><button class="category" type="button" data-folder="storage">貯蔵・保管</button></li>
                  <li><button class="category" type="button" data-folder="equipment">関連機器</button></li>
                  <li><button class="category" type="button" data-folder="plant">プラント事例</button></li>
                </ul>
              </details>
            </li>
          </ul>
        </nav>

        <section class="catalog-list branch-list" aria-live="polite" aria-label="製品一覧">
          <header class="catalog-list__header">
            <span class="catalog-list__eyebrow">製品リスト</span>
            <h3 id="catalog-list-title"></h3>
            <p id="catalog-list-description" class="catalog-list__description"></p>
          </header>
          <ul id="catalog-items" class="catalog-items"></ul>
        </section>

        <section class="catalog-insight branch-insight" aria-live="polite" aria-label="製品詳細">
          <div id="insight-placeholder" class="insight-placeholder">
          </div>

          <div id="insight-content" class="insight-content is-hidden">
            <figure class="insight-visual">
              <img id="insight-image" src="" alt="" />
              <figcaption id="insight-caption"></figcaption>
            </figure>
            <div class="insight-text">
              <h3 id="insight-title"></h3>
              <p id="insight-summary"></p>
              <p id="insight-meta" class="insight-meta"></p>
            </div>
            <div class="insight-queries">
              <p class="insight-queries__label">チャットボットに質問する</p>
              <p class="insight-queries__hint">
                質問例をクリックすると、チャット向けキーワードとして選択状態になります。
              </p>
              <div id="insight-suggestions" class="insight-suggestions" role="list"></div>
            </div>
          </div>
        </section>
      </section>
    </main>

    <script src="script.js"></script>
    <script>
      (() => {
        const layout = document.querySelector('.layout--branch');
        const nav = document.querySelector('.branch-rail');
        const itemsContainer = document.getElementById('catalog-items');
        const svg = document.querySelector('.branch-lines');
        if (!layout || !nav || !itemsContainer || !svg) return;

        const NS = 'http://www.w3.org/2000/svg';

        const clearCanvas = () => {
          while (svg.firstChild) {
            svg.removeChild(svg.firstChild);
          }
        };

        const createLine = (x1, y1, x2, y2, className) => {
          const line = document.createElementNS(NS, 'line');
          line.setAttribute('x1', x1);
          line.setAttribute('y1', y1);
          line.setAttribute('x2', x2);
          line.setAttribute('y2', y2);
          line.setAttribute('vector-effect', 'non-scaling-stroke');
          line.setAttribute('class', className);
          svg.appendChild(line);
        };

        const createCircle = (cx, cy, r, className) => {
          const circle = document.createElementNS(NS, 'circle');
          circle.setAttribute('cx', cx);
          circle.setAttribute('cy', cy);
          circle.setAttribute('r', r);
          circle.setAttribute('vector-effect', 'non-scaling-stroke');
          circle.setAttribute('class', className);
          svg.appendChild(circle);
        };

        const drawConnections = () => {
          clearCanvas();

          const active = nav.querySelector('.category.is-active');
          const itemButtons = Array.from(itemsContainer.querySelectorAll('.catalog-item'));

          if (!active || !itemButtons.length) {
            layout.classList.remove('has-active-branch');
            return;
          }

          layout.classList.add('has-active-branch');

          const layoutRect = layout.getBoundingClientRect();
          const activeRect = active.getBoundingClientRect();
          const listRect = itemsContainer.getBoundingClientRect();

          const width = layoutRect.width;
          const height = layoutRect.height;
          svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
          svg.setAttribute('width', width);
          svg.setAttribute('height', height);

          const startX = activeRect.right - layoutRect.left;
          const startY = activeRect.top + activeRect.height / 2 - layoutRect.top;
          const listLeft = listRect.left - layoutRect.left;
          let verticalX = listLeft - 24;
          verticalX = Math.min(verticalX, width - 24);
          verticalX = Math.max(startX + 12, verticalX);
          verticalX = Math.max(12, verticalX);

          const yPositions = [startY];
          const leafTargets = itemButtons.map((button) => {
            const rect = button.getBoundingClientRect();
            const y = rect.top + rect.height / 2 - layoutRect.top;
            const x = Math.max(verticalX + 12, rect.left - layoutRect.left - 8);
            yPositions.push(y);
            return { x, y };
          });

          const spineTop = Math.min(...yPositions);
          const spineBottom = Math.max(...yPositions);

          createLine(startX, startY, verticalX, startY, 'branch-line branch-line--main');
          createCircle(startX, startY, 4.5, 'branch-circle branch-circle--origin');

          createLine(verticalX, spineTop, verticalX, spineBottom, 'branch-line branch-line--spine');

          leafTargets.forEach(({ x, y }) => {
            createLine(verticalX, y, x, y, 'branch-line branch-line--leaf');
            createCircle(x, y, 3.5, 'branch-circle branch-circle--leaf');
          });

          createCircle(verticalX, startY, 3.8, 'branch-circle branch-circle--junction');
        };

        const scheduleDraw = () => requestAnimationFrame(drawConnections);

        const navObserver = new MutationObserver(scheduleDraw);
        navObserver.observe(nav, {
          attributes: true,
          attributeFilter: ['class'],
          subtree: true,
        });

        const listObserver = new MutationObserver(scheduleDraw);
        listObserver.observe(itemsContainer, {
          childList: true,
          subtree: true,
          attributes: true,
          attributeFilter: ['class'],
        });

        window.addEventListener('resize', scheduleDraw);
        document.addEventListener('DOMContentLoaded', scheduleDraw);
        scheduleDraw();
        setTimeout(scheduleDraw, 300);
      })();
    </script>
  </body>
</html>
