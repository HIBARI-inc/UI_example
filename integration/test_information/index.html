<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>テスト情報一覧</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body class="dashboard-body information-dashboard dashboard-body--plain">
    <main class="shell shell--wide dashboard-shell">
      <header class="information-header">
        <div class="information-header__titles">
          <h1 class="dashboard-title">粉体物性情報ダッシュボード</h1>
        </div>
        <div class="information-header__status">
          <p class="information-header__status-label">現在の表示期間</p>
          <p class="information-header__status-value" id="header-range">全期間</p>
        </div>
      </header>
      <main class="dashboard-main">
        <div class="filters-wrapper">
          <form class="dashboard-filters" id="filter-form" aria-label="期間フィルター">
            <div class="filter-group">
              <label class="filter-label" for="date-from">開始日</label>
              <input class="filter-input" type="date" id="date-from" name="date-from" />
            </div>
            <div class="filter-group">
              <label class="filter-label" for="date-to">終了日</label>
              <input class="filter-input" type="date" id="date-to" name="date-to" />
            </div>
            <button type="button" class="filter-button" id="filter-button">検索</button>
          </form>
        </div>
        <section class="dashboard-section" aria-live="polite">
          <header class="dashboard-section__header">
            <h2 class="dashboard-section__title">粉体物性情報</h2>
            <button type="button" class="control-button" id="export-button">
              <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                <path
                  fill="currentColor"
                  d="M12 3a1 1 0 0 1 1 1v8.59l2.3-2.3a1 1 0 1 1 1.4 1.42l-4 4a1 1 0 0 1-1.4 0l-4-4a1 1 0 1 1 1.4-1.42L11 12.59V4a1 1 0 0 1 1-1zM5 19a1 1 0 0 1 0-2h14a1 1 0 1 1 0 2H5z"
                ></path>
              </svg>
              エクスポート
            </button>
          </header>
          <div class="table-frame">
            <div class="data-table-wrapper">
              <table class="data-table" id="information-table">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <p class="data-table-footnote" id="selected-range">表示期間: 全期間</p>
        </section>
      </main>
    </main>
    <script>
      const csvPath = "./data/test_information.csv";
      let cachedRows = null;
      let cachedHeader = null;
      let cachedFilteredRows = [];

      // CSVの読み込みと整形を統括
      async function ensureCsvRows() {
        if (cachedRows) {
          return cachedRows;
        }
        const response = await fetch(csvPath);
        if (!response.ok) {
          throw new Error("CSVの取得に失敗しました");
        }
        const text = await response.text();
        cachedRows = parseCsv(text);
        return cachedRows;
      }

      function parseCsv(text) {
        return text
          .trim()
          .split(/\r?\n/)
          .filter((line) => line.trim() !== "")
          .map((line) => line.split(","));
      }

      function parseDateInput(value) {
        if (!value) {
          return null;
        }
        const [year, month, day] = value.split("-").map(Number);
        if (!year || !month || !day) {
          return null;
        }
        return new Date(year, month - 1, day);
      }

      function parseRecordDate(value) {
        if (!value) {
          return null;
        }
        const [year, month, day] = value.split("-").map(Number);
        if (!year || !month || !day) {
          return null;
        }
        return new Date(year, month - 1, day);
      }

      function formatDateForDisplay(value) {
        if (!value) {
          return "";
        }
        const year = value.getFullYear();
        const month = String(value.getMonth() + 1).padStart(2, "0");
        const day = String(value.getDate()).padStart(2, "0");
        return `${year}/${month}/${day}`;
      }

      function formatRangeLabel(fromDate, toDate) {
        if (!fromDate && !toDate) {
          return "表示期間: 全期間";
        }
        if (fromDate && toDate) {
          return `表示期間: ${formatDateForDisplay(fromDate)} 〜 ${formatDateForDisplay(toDate)}`;
        }
        if (fromDate) {
          return `表示期間: ${formatDateForDisplay(fromDate)} 以降`;
        }
        return `表示期間: ${formatDateForDisplay(toDate)} 以前`;
      }

      function renderTable(rows, fromDate, toDate) {
        const table = document.getElementById("information-table");
        const tableHead = table.querySelector("thead");
        const tableBody = table.querySelector("tbody");
        tableHead.innerHTML = "";
        tableBody.innerHTML = "";

        const rangeLabel = document.getElementById("selected-range");
        const headerRange = document.getElementById("header-range");
        const rangeText = formatRangeLabel(fromDate, toDate);
        cachedHeader = null;
        cachedFilteredRows = [];

        if (rows.length === 0) {
          rangeLabel.textContent = rangeText;
          if (headerRange) {
            headerRange.textContent = rangeText.replace("表示期間: ", "");
          }
          return;
        }

        const [header, ...records] = rows;
        cachedHeader = header;

        const headerRow = document.createElement("tr");
        header.forEach((label) => {
          const th = document.createElement("th");
          th.textContent = label.trim();
          headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        const filtered = records.filter((row) => {
          const dateCell = row[0] ? row[0].trim() : "";
          if (!dateCell) {
            return false;
          }
          const recordDate = parseRecordDate(dateCell);
          if (!recordDate) {
            return true;
          }
          if (fromDate && recordDate < fromDate) {
            return false;
          }
          if (toDate && recordDate > toDate) {
            return false;
          }
          return true;
        });

        cachedFilteredRows = filtered;
        rangeLabel.textContent = rangeText;
        if (headerRange) {
          headerRange.textContent = rangeText.replace("表示期間: ", "");
        }

        if (filtered.length === 0) {
          const emptyRow = document.createElement("tr");
          const emptyCell = document.createElement("td");
          emptyCell.colSpan = header.length;
          emptyCell.className = "data-table-empty";
          emptyCell.textContent = "指定された期間のデータはありません";
          emptyRow.appendChild(emptyCell);
          tableBody.appendChild(emptyRow);
          return;
        }

        const fragment = document.createDocumentFragment();
        filtered.forEach((row) => {
          const bodyRow = document.createElement("tr");
          row.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell.trim();
            bodyRow.appendChild(td);
          });
          fragment.appendChild(bodyRow);
        });
        tableBody.appendChild(fragment);
      }

      async function applyFilter() {
        try {
          const rows = await ensureCsvRows();
          const fromInput = document.getElementById("date-from");
          const toInput = document.getElementById("date-to");
          const fromDate = parseDateInput(fromInput.value);
          const toDate = parseDateInput(toInput.value);
          renderTable(rows, fromDate, toDate);
        } catch (error) {
          console.error(error);
          alert(`データの読み込みに失敗しました: ${error.message}`);
        }
      }

      function setupEventHandlers() {
        const button = document.getElementById("filter-button");
        const fromInput = document.getElementById("date-from");
        const toInput = document.getElementById("date-to");
        const exportButton = document.getElementById("export-button");
        if (button) {
          button.addEventListener("click", applyFilter);
        }
        [fromInput, toInput].forEach((input) => {
          if (!input) {
            return;
          }
          input.addEventListener("change", applyFilter);
        });
        if (exportButton) {
          exportButton.addEventListener("click", exportFilteredRows);
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        setupEventHandlers();
        await applyFilter();
      });

      function escapeCsvCell(value) {
        const safeValue = value == null ? "" : String(value);
        return `"${safeValue.replace(/"/g, '""')}"`;
      }

      function exportFilteredRows() {
        if (!cachedHeader || cachedFilteredRows.length === 0) {
          alert("エクスポートできるデータがありません。条件を変更してください。");
          return;
        }
        const lines = [
          cachedHeader.map((cell) => escapeCsvCell((cell || "").trim())).join(","),
          ...cachedFilteredRows.map((row) => row.map((cell) => escapeCsvCell((cell || "").trim())).join(",")),
        ];
        const csvContent = lines.join("\r\n");
        const blob = new Blob([`\uFEFF${csvContent}`], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "test_information_export.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
