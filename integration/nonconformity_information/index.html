<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>不適合情報ダッシュボード案6</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body class="dashboard-body blue-dashboard dashboard-body--plain">
    <main class="shell shell--wide dashboard-shell">
      <h1 class="blue-dashboard__header dashboard-title">不適合情報ダッシュボード案6</h1>

      <div class="dashboard-layout">
        <section class="dashboard-left" aria-label="集計条件と一覧">
          <form class="dashboard-filters dashboard-filters--grid" aria-label="期間指定フォーム">
            <div class="filter-group">
              <label for="date-from" class="filter-label">開始日</label>
              <input type="date" id="date-from" class="filter-input" value="2024-01-01" />
            </div>
            <div class="filter-group">
              <label for="date-to" class="filter-label">終了日</label>
              <input type="date" id="date-to" class="filter-input" value="2024-06-30" />
            </div>
            <button type="button" class="filter-button">検索</button>
          </form>

          <section class="blue-card dashboard-card data-card" aria-label="客先別不適合一覧">
            <header class="blue-card__header dashboard-card__header">
              <h2 class="blue-card__title dashboard-card__title">客先別不適合一覧</h2>
              <button type="button" class="control-button" id="export-button">
                <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    fill="currentColor"
                    d="M12 3a1 1 0 0 1 1 1v8.59l2.3-2.3a1 1 0 1 1 1.4 1.42l-4 4a1 1 0 0 1-1.4 0l-4-4a1 1 0 1 1 1.4-1.42L11 12.59V4a1 1 0 0 1 1-1zM5 19a1 1 0 0 1 0-2h14a1 1 0 1 1 0 2H5z"
                  ></path>
                </svg>
                エクスポート
              </button>
            </header>
            <h3 class="sr-only">客先別不適合一覧表</h3>
            <div class="component-frame component-frame--table">
              <div class="table-frame">
                <div class="data-table-wrapper">
                  <table id="data-table" class="data-table" aria-label="不適合情報一覧">
                    <thead></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        </section>

        <section class="dashboard-right" aria-label="グラフ表示">
          <nav class="chart-menu" aria-label="グラフ選択">
            <button type="button" class="chart-menu__item is-active" data-chart="img-amount" aria-pressed="true">期別対応コスト推移</button>
            <button type="button" class="chart-menu__item" data-chart="img-customer" aria-pressed="false">客先別対応状況</button>
            <button type="button" class="chart-menu__item" data-chart="img-cause-bar" aria-pressed="false">原因コード別件数</button>
            <button type="button" class="chart-menu__item" data-chart="img-cause-pie" aria-pressed="false">原因コード構成比</button>
            <button type="button" class="chart-menu__item" data-chart="img-phenomenon-bar" aria-pressed="false">現象コード別件数</button>
            <button type="button" class="chart-menu__item" data-chart="img-phenomenon-pie" aria-pressed="false">現象コード構成比</button>
          </nav>

          <div class="chart-display" role="region" aria-live="polite">
            <figure class="chart-panel is-active" data-chart="img-amount">
              <figcaption class="chart-panel__title">期別対応コスト推移</figcaption>
              <div class="component-frame component-frame--bar">
                <img
                  id="img-amount"
                  alt="期別対応コストの棒グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-customer">
              <figcaption class="chart-panel__title">客先別対応状況</figcaption>
              <div class="component-frame component-frame--bar">
                <img
                  id="img-customer"
                  alt="客先別件数と金額の棒グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-cause-bar">
              <figcaption class="chart-panel__title">原因コード別件数</figcaption>
              <div class="component-frame component-frame--bar">
                <img
                  id="img-cause-bar"
                  alt="原因コード別件数の棒グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-cause-pie">
              <figcaption class="chart-panel__title">原因コード構成比</figcaption>
              <div class="component-frame component-frame--pie">
                <img
                  id="img-cause-pie"
                  alt="原因コード構成比の円グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-phenomenon-bar">
              <figcaption class="chart-panel__title">現象コード別件数</figcaption>
              <div class="component-frame component-frame--bar">
                <img
                  id="img-phenomenon-bar"
                  alt="現象コード別件数の棒グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-phenomenon-pie">
              <figcaption class="chart-panel__title">現象コード構成比</figcaption>
              <div class="component-frame component-frame--pie">
                <img
                  id="img-phenomenon-pie"
                  alt="現象コード構成比の円グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>
          </div>
        </section>
      </div>
    </main>

    <div id="chartModal" class="chart-modal" role="dialog" aria-modal="true" aria-labelledby="chartModalCaption">
      <div class="chart-modal__content">
        <button id="chartModalClose" type="button" class="chart-modal__close" aria-label="閉じる">×</button>
        <img id="chartModalImg" class="chart-modal__img" alt="" />
        <p id="chartModalCaption" class="chart-modal__caption"></p>
      </div>
    </div>

    <script>
      const imageFiles = {
        "img-amount": "amount-bar.png",
        "img-cause-bar": "cause-bar.png",
        "img-cause-pie": "cause-pie.png",
        "img-customer": "customer-bar.png",
        "img-phenomenon-bar": "phenomenon-bar.png",
        "img-phenomenon-pie": "phenomenon-pie.png",
      };

      const headerTranslations = {
        date: "年月日",
        period: "年月日",
        product_no: "製番",
        customer: "客先",
        item_name: "品名",
        powder_name: "粉体名",
      };
      let currentHeader = null;
      let currentRows = [];

      function formatDisplayDate(value) {
        const match = value.match(/^(\d{4})Q([1-4])$/);
        if (!match) {
          const isoLike = value.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})$/);
          if (isoLike) {
            const [, year, month, day] = isoLike;
            return `${year}/${month}/${day}`;
          }
          return value;
        }

        const [, year, quarter] = match;
        const monthMap = {
          1: "01",
          2: "04",
          3: "07",
          4: "10",
        };
        const month = monthMap[quarter];
        return `${year}/${month}/01`;
      }

      function setImages() {
        const basePath = "./data";
        Object.entries(imageFiles).forEach(([id, file]) => {
          const element = document.getElementById(id);
          if (element) {
            element.src = `${basePath}/${file}`;
          }
        });
      }

      async function loadCsvTable() {
        const csvUrl = "./data/nonconformities.csv";
        const tableHead = document.querySelector("#data-table thead");
        const tableBody = document.querySelector("#data-table tbody");
        if (!tableHead || !tableBody) return;

        try {
          const response = await fetch(csvUrl);
          if (!response.ok) {
            throw new Error(`${response.status} ${response.statusText}`);
          }

          const text = await response.text();
          const rows = text
            .replace(/\r/g, "")
            .split("\n")
            .map((line) => line.trim())
            .filter((line) => line.length > 0)
            .map((line) => line.split(","));

          tableHead.innerHTML = "";
          tableBody.innerHTML = "";
          currentHeader = null;
          currentRows = [];

          if (rows.length === 0) {
            return;
          }

          const header = rows[0];
          currentHeader = header;
          const headerRow = document.createElement("tr");
          header.forEach((label) => {
            const key = label.trim();
            const th = document.createElement("th");
            th.textContent = headerTranslations[key] || key;
            headerRow.appendChild(th);
          });
          tableHead.appendChild(headerRow);

          const bodyRecords = rows.slice(1);
          currentRows = bodyRecords;
          bodyRecords.forEach((row) => {
            const bodyRow = document.createElement("tr");
            header.forEach((_, index) => {
              const rawCell = row[index] || "";
              const td = document.createElement("td");
              const value = index === 0 ? formatDisplayDate(rawCell.trim()) : rawCell.trim();
              td.textContent = value;
              bodyRow.appendChild(td);
            });
            tableBody.appendChild(bodyRow);
          });
        } catch (error) {
          console.error(error);
          alert(`CSVの読み込みに失敗しました: ${error.message}`);
        }
      }

    function escapeCsvCell(value) {
      const safeValue = value == null ? "" : String(value);
      return `"${safeValue.replace(/"/g, '""')}"`;
    }

    function exportCurrentTable() {
      if (!currentHeader || currentRows.length === 0) {
        alert("エクスポートできるデータがありません。条件を変更してください。");
        return;
      }
      const lines = [
        currentHeader.map((cell) => escapeCsvCell(cell.trim())).join(","),
        ...currentRows.map((row) => row.map((cell) => escapeCsvCell((cell || "").trim())).join(",")),
      ];
      const csvContent = lines.join("\r\n");
      const blob = new Blob([`\uFEFF${csvContent}`], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "nonconformities_export.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

      function registerImageModal() {
        const modal = document.getElementById("chartModal");
        const modalImg = document.getElementById("chartModalImg");
        const modalCaption = document.getElementById("chartModalCaption");
        const closeButton = document.getElementById("chartModalClose");
        if (!modal || !modalImg || !modalCaption) {
          return;
        }

        const openModal = (img) => {
          modalImg.src = img.src;
          modalImg.alt = img.alt;
          modalCaption.textContent = img.alt || "";
          modal.classList.add("is-active");
          document.body.classList.add("modal-open");
        };

        const closeModal = () => {
          modal.classList.remove("is-active");
          document.body.classList.remove("modal-open");
          modalImg.src = "";
          modalImg.alt = "";
          modalCaption.textContent = "";
        };

        document.querySelectorAll(".component-image").forEach((img) => {
          img.addEventListener("click", () => openModal(img));
        });

        if (closeButton) {
          closeButton.addEventListener("click", closeModal);
        }

        modal.addEventListener("click", (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && modal.classList.contains("is-active")) {
            closeModal();
          }
        });
      }

      function registerChartMenu() {
        const buttons = Array.from(document.querySelectorAll(".chart-menu__item"));
        const panels = Array.from(document.querySelectorAll(".chart-panel"));
        if (buttons.length === 0 || panels.length === 0) {
          return;
        }

        const activateChart = (chartId) => {
          buttons.forEach((button) => {
            const isActive = button.dataset.chart === chartId;
            button.classList.toggle("is-active", isActive);
            button.setAttribute("aria-pressed", String(isActive));
          });
          panels.forEach((panel) => {
            panel.classList.toggle("is-active", panel.dataset.chart === chartId);
          });
        };

        const initialButton = buttons.find((button) => button.classList.contains("is-active")) || buttons[0];
        if (initialButton) {
          activateChart(initialButton.dataset.chart);
        }

        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            activateChart(button.dataset.chart);
          });
        });
      }

      function initDashboard() {
        setImages();
        loadCsvTable();
        registerImageModal();
        registerChartMenu();

        const refreshButton = document.querySelector(".filter-button");
        const exportButton = document.getElementById("export-button");
        if (refreshButton) {
          refreshButton.addEventListener("click", () => {
            setImages();
            loadCsvTable();
          });
        }

        if (exportButton) {
          exportButton.addEventListener("click", exportCurrentTable);
        }
      }

      document.addEventListener("DOMContentLoaded", initDashboard);
    </script>
  </body>
</html>
