<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>不適合情報ダッシュボード案E</title>
    <link rel="stylesheet" href="../styles.css" />
    <style>
      body.blue-dashboard {
        margin: 0;
        min-height: 100vh;
        display: block;
        background: var(--gradient-base);
        color: var(--text-strong);
        font-family: "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif;
        padding: clamp(1.5rem, 4vw, 3rem);
      }

      body.modal-open {
        overflow: hidden;
      }

      .blue-dashboard__wrap {
        display: flex;
        flex-direction: column;
        gap: clamp(1.2rem, 2.4vw, 2rem);
      }

      .blue-dashboard__header {
        margin: 0;
        text-align: center;
        color: var(--text-strong);
        font-size: clamp(1.85rem, 2.2vw, 2.4rem);
        font-weight: 800;
        letter-spacing: 0.06em;
      }

      .dashboard-layout {
        display: grid;
        grid-template-columns: minmax(22rem, 1.3fr) minmax(20rem, 1fr);
        gap: clamp(1.2rem, 2.4vw, 2rem);
        align-items: start;
      }

      .dashboard-left,
      .dashboard-right {
        display: flex;
        flex-direction: column;
        gap: clamp(1rem, 2vw, 1.5rem);
      }

      .dashboard-filters {
        background: var(--panel);
        border-radius: var(--radius-lg);
        border: 0.0625rem solid var(--border);
        box-shadow: var(--shadow-md);
        padding: clamp(1rem, 1.6vw, 1.3rem);
        display: grid;
        grid-template-columns: repeat(2, minmax(9rem, 1fr));
        gap: clamp(0.7rem, 1.2vw, 1rem);
        align-content: start;
      }

      .dash-filter__hint {
        grid-column: 1 / -1;
        margin: 0;
        color: var(--text-muted);
        font-size: 0.85rem;
      }

      .blue-card {
        background: var(--panel);
        border: 0.0625rem solid var(--border);
        border-radius: var(--radius-lg);
        padding: clamp(1rem, 1.4vw, 1.4rem);
        box-shadow: var(--shadow-md);
        display: flex;
        flex-direction: column;
        gap: clamp(0.8rem, 1.3vw, 1.1rem);
        overflow: hidden;
      }

      .blue-card__header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.6rem;
        position: relative;
        z-index: 3;
      }

      .blue-card__title {
        margin: 0;
        font-size: clamp(1.1rem, 1.6vw, 1.35rem);
        font-weight: 700;
        letter-spacing: 0.04em;
      }

      .chart-menu {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        background: var(--panel);
        border: 0.0625rem solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: clamp(0.8rem, 1.4vw, 1.2rem);
      }

      .chart-menu__item {
        background: transparent;
        border: 0.0625rem solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text-muted);
        font-size: clamp(0.95rem, 1.1vw, 1.05rem);
        font-weight: 600;
        letter-spacing: 0.03em;
        padding: 0.75rem 1rem;
        text-align: left;
        cursor: pointer;
        transition: var(--transition);
      }

      .chart-menu__item:hover,
      .chart-menu__item:focus {
        outline: none;
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        box-shadow: 0 0 0 0.125rem rgba(63, 114, 255, 0.2);
      }

      .chart-menu__item.is-active {
        background: var(--accent-soft);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
      }

      .chart-display {
        background: var(--panel);
        border-radius: var(--radius-lg);
        border: 0.0625rem solid var(--border);
        box-shadow: var(--shadow-md);
        padding: clamp(1rem, 1.8vw, 1.6rem);
        min-height: 20rem;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        gap: clamp(0.8rem, 1.4vw, 1.2rem);
      }

      .chart-panel {
        display: none;
        margin: 0;
      }

      .chart-panel.is-active {
        display: block;
      }

      .chart-panel__title {
        margin: 0;
        font-size: clamp(1.1rem, 1.5vw, 1.35rem);
        font-weight: 700;
        letter-spacing: 0.04em;
        color: var(--text-strong);
      }

      .component-frame {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        min-height: 12rem;
        border: 0;
        border-radius: 0;
        background: transparent;
      }

      .component-frame--bar,
      .component-frame--pie {
        min-height: 16rem;
        aspect-ratio: 16 / 9;
      }

      .component-frame--table {
        min-height: 30rem;
        display: block;
      }

      .component-image {
        display: block;
        width: 100%;
        height: 100%;
        max-height: 100%;
        object-fit: contain;
        cursor: zoom-in;
      }

      .data-table-container {
        position: relative;
        border-radius: var(--radius-md);
        background: var(--panel);
        padding: 0.6rem;
      }

      .data-table-wrapper {
        max-height: 34rem;
        overflow: auto;
        border-radius: var(--radius-md);
        border: 0.0625rem solid var(--border);
        box-sizing: border-box;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }

      .data-table th,
      .data-table td {
        padding: 0.55rem 0.65rem;
        text-align: left;
        border-bottom: 0.0625rem solid var(--border);
      }

      .data-table thead th {
        position: sticky;
        top: 0;
        background: #f5f7ff;
        box-shadow: inset 0 -0.0625rem 0 var(--border);
        z-index: 2;
      }

      .note-card {
        gap: 0.6rem;
      }

      .note-card p {
        margin: 0;
        line-height: 1.6;
      }

      .chart-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.65);
        padding: clamp(1rem, 4vw, 3rem);
        opacity: 0;
        pointer-events: none;
        transition: opacity 180ms ease;
        z-index: 999;
      }

      .chart-modal.is-active {
        opacity: 1;
        pointer-events: auto;
      }

      .chart-modal__content {
        position: relative;
        max-width: min(90vw, 72rem);
        max-height: 90vh;
        border-radius: var(--radius-lg);
        background: var(--panel);
        box-shadow: var(--shadow-lg);
        padding: clamp(1rem, 2vw, 1.8rem);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .chart-modal__img {
        width: 100%;
        height: 100%;
        max-height: calc(90vh - 6rem);
        object-fit: contain;
        border-radius: var(--radius-md);
        background: #fff;
      }

      .chart-modal__caption {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      .chart-modal__close {
        position: absolute;
        top: 0.6rem;
        right: 0.6rem;
        border: none;
        background: rgba(25, 34, 56, 0.55);
        color: #fff;
        width: 2.2rem;
        height: 2.2rem;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
      }

      .chart-modal__close:hover {
        background: rgba(15, 23, 42, 0.8);
      }

      @media (max-width: 1100px) {
        .dashboard-layout {
          grid-template-columns: 1fr;
        }

        .dashboard-right {
          order: -1;
        }

        .chart-menu {
          flex-direction: row;
          flex-wrap: wrap;
        }

        .chart-menu__item {
          flex: 1 1 calc(50% - 0.6rem);
        }
      }

      @media (max-width: 720px) {
        .dashboard-filters {
          grid-template-columns: 1fr;
        }

        .chart-menu__item {
          flex: 1 1 100%;
        }
      }
    </style>
  </head>
  <body class="blue-dashboard">
    <main class="shell shell--wide blue-dashboard__wrap">
      <h1 class="blue-dashboard__header">不適合情報ダッシュボード案E</h1>

      <div class="dashboard-layout">
        <section class="dashboard-left" aria-label="集計条件と一覧">
          <form class="dashboard-filters" aria-label="期間指定フォーム">
            <div class="filter-group">
              <label for="date-from" class="filter-label">開始日</label>
              <input type="date" id="date-from" class="filter-input" value="2024-01-01" />
            </div>
            <div class="filter-group">
              <label for="date-to" class="filter-label">終了日</label>
              <input type="date" id="date-to" class="filter-input" value="2024-06-30" />
            </div>
            <button type="button" class="filter-button">検索</button>
            <p class="dash-filter__hint">※現在検索機能はつけていません</p>
          </form>

          <section class="blue-card data-card" aria-label="客先別不適合一覧">
            <header class="blue-card__header">
              <h2 class="blue-card__title">客先別不適合一覧</h2>
            </header>
            <div class="component-frame component-frame--table">
              <div class="data-table-container">
                <div class="data-table-header">
                  <h3 class="sr-only">客先別不適合一覧表</h3>
                </div>
                <div class="data-table-wrapper">
                  <table id="data-table" class="data-table" aria-label="不適合情報一覧">
                    <thead></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        </section>

        <section class="dashboard-right" aria-label="グラフ表示">
          <nav class="chart-menu" aria-label="グラフ選択">
            <button type="button" class="chart-menu__item is-active" data-chart="img-amount" aria-pressed="true">期別対応コスト推移</button>
            <button type="button" class="chart-menu__item" data-chart="img-customer" aria-pressed="false">客先別対応状況</button>
            <button type="button" class="chart-menu__item" data-chart="img-cause-bar" aria-pressed="false">原因コード別件数</button>
            <button type="button" class="chart-menu__item" data-chart="img-cause-pie" aria-pressed="false">原因コード構成比</button>
            <button type="button" class="chart-menu__item" data-chart="img-phenomenon-bar" aria-pressed="false">現象コード別件数</button>
            <button type="button" class="chart-menu__item" data-chart="img-phenomenon-pie" aria-pressed="false">現象コード構成比</button>
          </nav>

          <div class="chart-display" role="region" aria-live="polite">
            <figure class="chart-panel is-active" data-chart="img-amount">
              <figcaption class="chart-panel__title">期別対応コスト推移</figcaption>
              <div class="component-frame component-frame--bar">
                <img
                  id="img-amount"
                  alt="期別対応コストの棒グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-customer">
              <figcaption class="chart-panel__title">客先別対応状況</figcaption>
              <div class="component-frame component-frame--bar">
                <img
                  id="img-customer"
                  alt="客先別件数と金額の棒グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-cause-bar">
              <figcaption class="chart-panel__title">原因コード別件数</figcaption>
              <div class="component-frame component-frame--bar">
                <img
                  id="img-cause-bar"
                  alt="原因コード別件数の棒グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-cause-pie">
              <figcaption class="chart-panel__title">原因コード構成比</figcaption>
              <div class="component-frame component-frame--pie">
                <img
                  id="img-cause-pie"
                  alt="原因コード構成比の円グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-phenomenon-bar">
              <figcaption class="chart-panel__title">現象コード別件数</figcaption>
              <div class="component-frame component-frame--bar">
                <img
                  id="img-phenomenon-bar"
                  alt="現象コード別件数の棒グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>

            <figure class="chart-panel" data-chart="img-phenomenon-pie">
              <figcaption class="chart-panel__title">現象コード構成比</figcaption>
              <div class="component-frame component-frame--pie">
                <img
                  id="img-phenomenon-pie"
                  alt="現象コード構成比の円グラフ"
                  class="component-image"
                  loading="lazy"
                />
              </div>
            </figure>
          </div>
        </section>
      </div>
    </main>

    <div id="chartModal" class="chart-modal" role="dialog" aria-modal="true" aria-labelledby="chartModalCaption">
      <div class="chart-modal__content">
        <button id="chartModalClose" type="button" class="chart-modal__close" aria-label="閉じる">×</button>
        <img id="chartModalImg" class="chart-modal__img" alt="" />
        <p id="chartModalCaption" class="chart-modal__caption"></p>
      </div>
    </div>

    <script>
      const imageFiles = {
        "img-amount": "amount-bar.png",
        "img-cause-bar": "cause-bar.png",
        "img-cause-pie": "cause-pie.png",
        "img-customer": "customer-bar.png",
        "img-phenomenon-bar": "phenomenon-bar.png",
        "img-phenomenon-pie": "phenomenon-pie.png",
      };

      const headerTranslations = {
        date: "年月日",
        period: "年月日",
        product_no: "製番",
        customer: "客先",
        item_name: "品名",
        powder_name: "粉体名",
      };

      function formatDisplayDate(value) {
        const match = value.match(/^(\d{4})Q([1-4])$/);
        if (!match) {
          const isoLike = value.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})$/);
          if (isoLike) {
            const [, year, month, day] = isoLike;
            return `${year}/${month}/${day}`;
          }
          return value;
        }

        const [, year, quarter] = match;
        const monthMap = {
          1: "01",
          2: "04",
          3: "07",
          4: "10",
        };
        const month = monthMap[quarter];
        return `${year}/${month}/01`;
      }

      function setImages() {
        const basePath = "./data";
        Object.entries(imageFiles).forEach(([id, file]) => {
          const element = document.getElementById(id);
          if (element) {
            element.src = `${basePath}/${file}`;
          }
        });
      }

      async function loadCsvTable() {
        const csvUrl = "./data/nonconformities.csv";
        const tableHead = document.querySelector("#data-table thead");
        const tableBody = document.querySelector("#data-table tbody");
        if (!tableHead || !tableBody) return;

        try {
          const response = await fetch(csvUrl);
          if (!response.ok) {
            throw new Error(`${response.status} ${response.statusText}`);
          }

          const text = await response.text();
          const rows = text
            .replace(/\r/g, "")
            .split("\n")
            .map((line) => line.trim())
            .filter((line) => line.length > 0)
            .map((line) => line.split(","));

          tableHead.innerHTML = "";
          tableBody.innerHTML = "";

          if (rows.length === 0) {
            return;
          }

          const header = rows[0];
          const headerRow = document.createElement("tr");
          header.forEach((label) => {
            const key = label.trim();
            const th = document.createElement("th");
            th.textContent = headerTranslations[key] || key;
            headerRow.appendChild(th);
          });
          tableHead.appendChild(headerRow);

          rows.slice(1).forEach((row) => {
            const bodyRow = document.createElement("tr");
            header.forEach((_, index) => {
              const rawCell = row[index] || "";
              const td = document.createElement("td");
              const value = index === 0 ? formatDisplayDate(rawCell.trim()) : rawCell.trim();
              td.textContent = value;
              bodyRow.appendChild(td);
            });
            tableBody.appendChild(bodyRow);
          });
        } catch (error) {
          console.error(error);
          alert(`CSVの読み込みに失敗しました: ${error.message}`);
        }
      }

      function registerImageModal() {
        const modal = document.getElementById("chartModal");
        const modalImg = document.getElementById("chartModalImg");
        const modalCaption = document.getElementById("chartModalCaption");
        const closeButton = document.getElementById("chartModalClose");
        if (!modal || !modalImg || !modalCaption) {
          return;
        }

        const openModal = (img) => {
          modalImg.src = img.src;
          modalImg.alt = img.alt;
          modalCaption.textContent = img.alt || "";
          modal.classList.add("is-active");
          document.body.classList.add("modal-open");
        };

        const closeModal = () => {
          modal.classList.remove("is-active");
          document.body.classList.remove("modal-open");
          modalImg.src = "";
          modalImg.alt = "";
          modalCaption.textContent = "";
        };

        document.querySelectorAll(".component-image").forEach((img) => {
          img.addEventListener("click", () => openModal(img));
        });

        if (closeButton) {
          closeButton.addEventListener("click", closeModal);
        }

        modal.addEventListener("click", (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && modal.classList.contains("is-active")) {
            closeModal();
          }
        });
      }

      function registerChartMenu() {
        const buttons = Array.from(document.querySelectorAll(".chart-menu__item"));
        const panels = Array.from(document.querySelectorAll(".chart-panel"));
        if (buttons.length === 0 || panels.length === 0) {
          return;
        }

        const activateChart = (chartId) => {
          buttons.forEach((button) => {
            const isActive = button.dataset.chart === chartId;
            button.classList.toggle("is-active", isActive);
            button.setAttribute("aria-pressed", String(isActive));
          });
          panels.forEach((panel) => {
            panel.classList.toggle("is-active", panel.dataset.chart === chartId);
          });
        };

        const initialButton = buttons.find((button) => button.classList.contains("is-active")) || buttons[0];
        if (initialButton) {
          activateChart(initialButton.dataset.chart);
        }

        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            activateChart(button.dataset.chart);
          });
        });
      }

      function initDashboard() {
        setImages();
        loadCsvTable();
        registerImageModal();
        registerChartMenu();

        const refreshButton = document.querySelector(".filter-button");
        if (refreshButton) {
          refreshButton.addEventListener("click", () => {
            setImages();
            loadCsvTable();
          });
        }
      }

      document.addEventListener("DOMContentLoaded", initDashboard);
    </script>
  </body>
</html>
